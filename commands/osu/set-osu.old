const { SlashCommandBuilder } = require('discord.js');
const fs = require('fs');
const { textConfirmation } = require('../../lib/embeds/text-confirmation.js');

module.exports = {
  data: new SlashCommandBuilder()
    .setName('set-osu')
    .setDescription("Set your osu! account in order to be able to use certain commands.")
    .addStringOption(option => option.setName('nickname')
      .setDescription('Make sure your nickname matches with your actual osu! account')
      .setRequired(true)
    ),
  async execute(interaction) {
    // Send message then edit later
    await interaction.deferReply();

    // Init empty var
    var userEmbed;

    // Fetch user's input
    const nicknameInput = interaction.options.getString('nickname');
    const discordUserInput = interaction.user.id;
    const filePath = 'lib/localdb/osuNickname.json';

    const jsonData = JSON.parse(fs.readFileSync(filePath));

    const newObj = {
      osuNickname: nicknameInput,
    };

    // Convert nickname to user ID
    jsonData[discordUserInput] = newObj;
    const jsonString = JSON.stringify(jsonData, null, 2); // Stringify with indentation

    try {
      fs.writeFileSync(filePath, jsonString);
      console.log(`[Report] osu! nickname saved by ${interaction.user.id}`);
      userEmbed = await textConfirmation("Your nickname has been saved.", "primary");
    } catch (error) {
      console.error('Error writing JSON data:', error);
      userEmbed = await textConfirmation("Something went wrong. Please contact <@191715988352401408>", "danger");
    }

    await interaction.editReply({ embeds: [userEmbed] });
  },
};