const { SlashCommandBuilder } = require('discord.js');
const fs = require('fs');
const { getCredentials } = require('../../lib/osu/osuAuth.js');
const { beatmapUserScore, beatmapInfo } = require('../../lib/osu/beatmap.js');
const { convertUserUrl } = require('../../lib/osu/users.js');
const { showRecentActivityCompare } = require('../../lib/embeds/users.js');
const { textConfirmation } = require('../../lib/embeds/text-confirmation.js');

module.exports = {
  data: new SlashCommandBuilder()
    .setName('compare')
    .setDescription("Compare latest /recent score"),
  async execute(interaction) {
    // Loading message
    await interaction.deferReply();

    var beatmapScore, beatmapMeta, showEmbed;
    const osuToken = await getCredentials();
    const discordUserInput = interaction.user.id;

    const filePathNickname = 'lib/localdb/osuNickname.json';
    const filePathRecent = 'lib/localdb/recent.json';

    const jsonDataNickname = JSON.parse(fs.readFileSync(filePathNickname));
    const jsonDataRecent = JSON.parse(fs.readFileSync(filePathRecent));

    try {
      const hasNickname = jsonDataNickname[discordUserInput].osuNickname;
      const convertedUrl = await convertUserUrl(hasNickname);

      try {
        beatmapScore = await beatmapUserScore(osuToken, jsonDataRecent.beatmap_id, convertedUrl);
        beatmapMeta = await beatmapInfo(osuToken, jsonDataRecent.beatmap_id);
        showEmbed = await showRecentActivityCompare(beatmapScore.data.score, beatmapMeta.data);
      } catch (e) {
        showEmbed = await textConfirmation("No score was submitted in this beatmap.", "danger");
      }
    } catch (error) {
      showEmbed = await textConfirmation("You haven't set your osu! nickname. Please use /set-osu first", "danger");
    }

    await interaction.editReply({ embeds: [showEmbed] });
  },
};